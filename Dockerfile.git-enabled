<<<<<<< HEAD
FROM node:20-alpine AS builder

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install all dependencies for build
RUN npm ci

# Copy source code
COPY . .

# Build the React frontend
RUN npm run build

# Production stage with Git support
FROM node:20-alpine

WORKDIR /app

# Install Git, PostgreSQL client, and other tools
RUN apk add --no-cache git postgresql-client curl bash

# Create package.json with required dependencies
RUN echo '{"name":"ticket-management","version":"1.0.0","dependencies":{"express":"^4.18.2","pg":"^8.11.3","cors":"^2.8.5"}}' > package.json
RUN npm install

# Copy built frontend from builder stage
COPY --from=builder /app/client/dist ./client/dist

# Copy server files
COPY server/ ./server/
COPY shared/ ./shared/

# Copy container-specific server
COPY container-server.js ./server/start.js

# Copy git update script
COPY git-update-script.sh ./update.sh
RUN chmod +x ./update.sh

# Create git configuration directory
RUN mkdir -p /root/.ssh

# Set up git global configuration
RUN git config --global user.name "Container User" && \
    git config --global user.email "container@localhost" && \
    git config --global init.defaultBranch main

EXPOSE 5000
ENV NODE_ENV=production

# Initialize as git repository on startup
RUN git init . && \
    git add . && \
    git commit -m "Initial container setup" || true

CMD ["node", "server/start.js"]
=======
FROM node:20-alpine

# Install git and other essential tools
RUN apk add --no-cache git

WORKDIR /app

# Copy package files and install dependencies
COPY package*.json ./
RUN npm ci --only=production

# Copy all source files
COPY . .

# Build the frontend
RUN npm run build

# Install additional production dependencies for container server
RUN npm install pg@^8.11.3 cors@^2.8.5

# Copy the interactive container server
COPY container-interactive-server.js ./

# Create startup script with git info
RUN echo '#!/bin/sh' > /app/start.sh && \
    echo 'echo "Starting Season Ticket Management System..."' >> /app/start.sh && \
    echo 'echo "Git version: $(git --version)"' >> /app/start.sh && \
    echo 'echo "Database: $DATABASE_URL"' >> /app/start.sh && \
    echo 'node container-interactive-server.js' >> /app/start.sh && \
    chmod +x /app/start.sh

EXPOSE 5050
ENV NODE_ENV=production

# Use the startup script
CMD ["/app/start.sh"]
>>>>>>> 21aa58d (Initial commit)
